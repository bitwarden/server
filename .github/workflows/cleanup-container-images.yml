name: Cleanup Container Images

on:
  delete:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.ref }}
  cancel-in-progress: false

jobs:
  cleanup-images:
    name: Delete branch container images
    if: |
      github.event.ref != 'rc' &&
      github.event.ref != 'hotfix-rc'
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_name: Admin
          - image_name: Api
          - image_name: Attachments
          - image_name: Billing
          - image_name: Events
          - image_name: EventsProcessor
          - image_name: Icons
          - image_name: Identity
          - image_name: MsSql
          - image_name: MsSqlMigratorUtility
          - image_name: Nginx
          - image_name: Notifications
          - image_name: Scim
          - image_name: Setup
          - image_name: Sso
    steps:
      - name: Generate image tag to delete
        id: tag
        uses: bitwarden/gh-actions/container-tag@main
        with:
          ref: refs/heads/${{ github.event.ref }}

      - name: Delete container image version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          # Convert image name to lowercase to match GHCR naming
          IMAGE_NAME=$(echo "${{ matrix.image_name }}" | tr '[:upper:]' '[:lower:]')

          echo "Processing cleanup for image: ${IMAGE_NAME}:${IMAGE_TAG}"

          # Get the version ID for this specific tag
          VERSION_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/bitwarden/packages/container/${IMAGE_NAME}/versions" \
            --jq ".[] | select(.metadata.container.tags[] == \"${IMAGE_TAG}\") | .id" \
            | head -1)

          if [[ -n "${VERSION_ID}" ]]; then
            echo "Deleting image ${IMAGE_NAME} with tag: ${IMAGE_TAG} (version ID: ${VERSION_ID})"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/bitwarden/packages/container/${IMAGE_NAME}/versions/${VERSION_ID}"
            echo "Successfully deleted image"
          else
            echo "No image found for ${IMAGE_NAME} with tag: ${IMAGE_TAG}"
          fi
